<!DOCTYPE html>
<html>
    <head>
        <title>Make Photo 16x9</title>
        <meta charset="utf8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <meta name="apple-mobile-web-app-title" content='Make Photo 16x9' />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <link rel="apple-touch-icon" href="icon.png" />
        
        <style>
            body {
                text-align: center;
                font-family: 'Helvetica Neue', Arial, sans-serif;
                background:white;
                color:#646369 ;
                padding: 0px;
                margin: 0px;
            }

            a, a:visited {
                color: #06f;
            }

            html {
                padding: 0px;
            }
 
            #canvas-wrapper {
                display: inline-block;
                position: relative;
                width: auto;
                max-width: 80%;
                margin: auto;
            }
            
            h1 {
                margin-top: 0px;
                padding: 30px 0px;
                color:#06f;
                border-bottom: solid 1px #ccc;
            }

            h3 {
                font-size: 60px;
                line-height: 60px;
                margin-top: 20%;
            }

            h5 {
                margin-top: -5%;
                font-size: 20px;
            }

            #instructions {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0px;
                left: 0px;
                pointer-events: none;
            }

            canvas {
                position: relative;
                display: block;
                border:solid 7px white;
                box-shadow: gray 0 0 5px;
                background:#e3e3e3;
                border-radius: 1px;
                max-width: 100%;
                box-sizing: border-box;
            }

            button {
                width: 110px;
                height: 30px;
                border-radius: 5px;
                background: #06f;
                color: white;
                font-weight: bold;
                margin: 5px;
            }

            #download-image {
                display: block;
                margin: 20px auto;
                width: 160px;
            }

            input {
                font-size:20px;
                width:60px;
            }
            label {
                font-size:20px;
            }

            p {
                max-width: 600px;
                margin: 20px auto;
                text-align: left;
                font-size: 14px;
                padding: 0px 10px;
            }

            #controls {
                max-width: 90%;
                margin: auto;
            }

            #upload-file {
                display: none;
            }

            #tp {
                display: none;
            }

            @media (max-width: 700px) {
                h3 {
                    font-size: 40px;
                    line-height: 40px;
                }

                h5 {
                    font-size: 16px;
                }
            }

            @media (max-width: 500px) {
                h3 {
                    font-size: 34px;
                    line-height: 34px;
                }

                h5 {
                    font-size: 14px;
                }
            }

            @media (max-width: 359px) {
                h3 {
                    font-size: 28px;
                    line-height: 28px;
                }

                h5 {
                    font-size: 12px;
                }
            }

            @media (min-width: 850px) {
                #canvas-wrapper {
                    max-width: 600px;
                }
            }

        </style>
    </head>
    <body onload="setup()">
        <h1>Make photo 16x9</h1>
        <h4>The easiest way to make your entire photo fit well into a tweet!</h4>
        <div id="canvas-wrapper">
            <canvas id="c" width="800" height="450"></canvas>
            <div id="instructions">
                <h3>Drop photo here</h3>
                <h5>Or click to choose a photo</h5>
            </div>
        </div>

        <button id="download-image">Download Image</button>
        <div id="controls">
            <h4>Fill empty space with:</h4>
            <button id="detected-color">Detected color</button> </button><button id="black">Black</button> <button id="white">White</button> <button id="transparent">Transparency</button> <button id="blur">Blur</button>
        </div>

        <p>
            Ever been tweeting out an image that's very short and wide, maybe it's just a couple of lines of text, and it gets cropped horribly so people have to 
            click on the image to even see the full text? Well, here you can pad that image out to the aspect ratio 16x9, which is what Twitter shows it as,
            so people can read your image text immediately.  
        </p>
        <p>
            This page was made by <a href="https://twitter.com/einaregilsson">@einaregilsson</a>, give me shout-out on Twitter if you find it useful.
            You can also read the <a href="https://einaregilsson.com/make-photo-16x9/">blog post</a> about how it came to be if you're interested in the technical stuff.
        </p>

        <p>
            <strong>Cookie policy:</strong> We don't use any cookies or tracking scripts, at all. In fact you can see the entire source code of this page
            by clicking on View Source in your browser, it's all in this one file.
        </p>
        <div id="tp">
            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="32" height="32">
                <rect fill="white" x="0" y="0" height="16" width="16" />
                <rect fill="white" x="16" y="16" height="16" width="16" />
            </svg>
        </div>

        <input type="file" id="upload-file"/>

        <script>

            //Globals, always apply to current image
            var canvas, ctx, image, filename;
            var dx, dy;
            var isLandscape;

            function noImage() {
                alert('Start by uploading an image.');
            }

            function downloadImage() {
                if (!image) {
                    return noImage();
                }
                var dataURL = canvas.toDataURL('image/png');

                var a = document.createElement('a');
                a.href = dataURL;
                a.target = '_blank';
                var downloadFilename = filename.replace(/\.[a-zA-Z]{3,4}$/, '_16x9.png');

                //If it's an iOS generated guid name, change it to something better...

                if (downloadFilename.match(/[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}/)) {
                    downloadFilename = 'photo_16x9.png';
                }
                a.setAttribute('download', downloadFilename);
                a.click();
            }

            function fillBlack() {
                fillColor('black');
            }

            function fillWhite() {
                fillColor('white');
            }

            function fillTransparent() {
                if (!image) {
                    return noImage();
                }

                canvas.width = canvas.width;
                var base64encoded = btoa(document.getElementById('tp').innerHTML);
                document.getElementById('c').style.backgroundImage = 'url(data:image/svg+xml;base64,' + base64encoded + ')';
                drawImage();
            }

            function rgbToHex(r, g, b) {
                return ((r << 16) | (g << 8) | b).toString(16);
            }

            function fillDetectedColor() {
                if (!image) {
                    return noImage();
                }

                var counter = {};

                function addPixel(x, y) {
                    var pixel = ctx.getImageData(x, y, 1, 1).data;
                    var hexColor = '#' + rgbToHex(pixel[0], pixel[1], pixel[2]);
                    counter[hexColor] = (counter[hexColor] || 0) + 1;
                }

                if (isLandscape) {
                    for (var i=0; i < image.width; i++) {
                        addPixel(i, dy);
                        addPixel(i, dy + image.height - 1);
                    }
                } else {
                    for (var i=0; i < image.height; i++) {
                        addPixel(dx, i);
                        addPixel(dx + image.width - 1, i);
                    }
                }

                var maxColor, maxCount = 0;
                for (var c in counter) {
                    if (counter[c] > maxCount) {
                        maxColor = c;
                        maxCount = counter[c];
                    }
                }
                fillColor(maxColor);
            }

            function fillBlur() {
                if (!image) {
                    return noImage();
                }

                //Don't want checkered background here...
                document.getElementById('c').style.backgroundImage = '';

                ctx.filter = 'blur(8px)';
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                ctx.filter = 'none';
                drawImage();
            }

            function clickCanvas() {
                document.getElementById('upload-file').click();
            }

            function fillColor(color) {
                if (!image) {
                    return noImage();
                }
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawImage();
            }
            
            function drawImage() {
                if (image) {
                    ctx.drawImage(image, dx, dy, image.width, image.height);
                }
            }
            function setup() {
                canvas = document.getElementById('c');
                ctx = canvas.getContext('2d');

                canvas.addEventListener('drop', drop);
                canvas.addEventListener('dragover', function(ev) {
                    ev.preventDefault();
                });
                canvas.addEventListener('mousedown', clickCanvas);

                var fileUpload = document.getElementById('upload-file');
                fileUpload.addEventListener('change', fileSelectedInDialog);

                //Set up fill styles...
                document.getElementById('black').addEventListener('click', fillBlack);
                document.getElementById('white').addEventListener('click', fillWhite);
                document.getElementById('transparent').addEventListener('click', fillTransparent);
                document.getElementById('blur').addEventListener('click', fillBlur);
                document.getElementById('detected-color').addEventListener('click', fillDetectedColor);

                document.getElementById('download-image').addEventListener('click', downloadImage);
            }

            function drop(ev) {
                ev.stopPropagation();
                ev.preventDefault();

                var files = ev.dataTransfer.files;
                if(files && typeof FileReader !== "undefined") {
                    readFile(files[0]);
                } else {
                    alert("Can't read file 🙁");
                }
            }

            function fileLoaded(e) {
                image = new Image();
                image.src = e.target.result;
                image.onload = imageLoaded;  
            }

            function imageLoaded(e) {
                image = e.target;
                
                document.getElementById('instructions').style.display = 'none';

                //Now, see which way it is...
                var calculatedHeight = Math.round((image.width / 16) * 9);
                var calculatedWidth = Math.round((image.height / 9) * 16);
                dx = 0;
                dy = 0;

                //Need to pad above and below
                if (calculatedHeight > image.height) {
                    isLandscape = true;
                    dy = Math.round((calculatedHeight - image.height) / 2);
                    canvas.width = image.width;
                    canvas.height = calculatedHeight;
                } else {
                    isLandscape = false;
                    dx = Math.round((calculatedWidth - image.width) / 2);
                    canvas.width = calculatedWidth;
                    canvas.height = image.height;
                }
                
                fillTransparent();
            }

            function fileSelectedInDialog(e) {
                readFile(e.target.files[0]);
            }

            function readFile(file) {
                if (!/image/i.test(file.type)) {
                    alert('Only image files are supported!');
                    return;
                }
                filename = file.name;
                var reader = new FileReader();
                reader.onload = fileLoaded;
                reader.readAsDataURL(file);
            }
        </script>
    </body>
</html>
